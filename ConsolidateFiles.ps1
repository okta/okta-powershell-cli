#
# Script to consolidate PS1 files into single files per folder
# This improves module load performance by reducing the number of dot-source operations
# See: https://github.com/okta/okta-powershell-cli/issues/41
#

param(
    [string]$BasePath = "$PSScriptRoot\src\Okta.PowerShell"
)

$header = @"
#
# Okta Management
# Allows customers to easily access the Okta Management APIs
# Version: 3.0.0
# Contact: devex-public@okta.com
# Generated by OpenAPI Generator: https://openapi-generator.tech
#
# This file consolidates all functions for improved module load performance.
# See: https://github.com/okta/okta-powershell-cli/issues/41
#

"@

# Function to remove the standard header from file content
function Remove-StandardHeader {
    param([string]$Content)
    
    # Remove the OpenAPI Generator header comment block
    $Content -replace '(?ms)^#\s*\r?\n#\s*Okta Management\r?\n#\s*Allows customers to easily access the Okta Management APIs\r?\n#\s*Version:.*?\r?\n#\s*Contact:.*?\r?\n#\s*Generated by OpenAPI Generator:.*?\r?\n#\s*\r?\n', ''
}

# Process each folder
$folders = @('Api', 'Model', 'Client', 'Private')

foreach ($folder in $folders) {
    $folderPath = Join-Path $BasePath $folder
    $outputFile = Join-Path $BasePath "$folder.ps1"
    
    if (-not (Test-Path $folderPath)) {
        Write-Warning "Folder not found: $folderPath"
        continue
    }
    
    $files = Get-ChildItem -Path $folderPath -Filter '*.ps1' | Sort-Object Name
    
    if ($files.Count -eq 0) {
        Write-Warning "No PS1 files found in: $folderPath"
        continue
    }
    
    Write-Host "Processing $folder folder: $($files.Count) files..."
    
    $content = $header
    
    foreach ($file in $files) {
        $fileContent = Get-Content $file.FullName -Raw
        $fileContent = Remove-StandardHeader -Content $fileContent
        
        $content += "`n#region $($file.BaseName)`n"
        $content += $fileContent.Trim()
        $content += "`n#endregion $($file.BaseName)`n"
    }
    
    # Write to UTF8 without BOM
    $utf8NoBom = New-Object System.Text.UTF8Encoding $false
    [System.IO.File]::WriteAllText($outputFile, $content, $utf8NoBom)
    
    Write-Host "  Created: $outputFile"
}

Write-Host "`nConsolidation complete!"
